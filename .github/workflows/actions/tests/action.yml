name: 'Run Tests'
description: 'Runs test executables and reports results'

inputs:
  build-dir:
    description: 'CMake build directory'
    required: true
  cache-key:
    description: 'Prefix for cache keys'
    required: true

runs:
  using: "composite"
  steps:
    # Step 1: Restore build cache
    - name: Restore Build Cache
      uses: actions/cache/restore@v3
      with:
        path: |
          ${{ inputs.build-dir }}
          ${{ inputs.build-dir }}/CMakeCache.txt
          ${{ inputs.build-dir }}/CMakeFiles
          ${{ inputs.build-dir }}/_deps
        key: ${{ inputs.cache-key }}-build

    # Step 3: Create coverage directory
    - name: Create Coverage Directory
      id: create-coverage-dir
      shell: pwsh
      run: |
        Remove-Item -Recurse -Force ${{ inputs.build-dir }}\bin\coverage
        mkdir -p ${{ inputs.build-dir }}\bin\coverage

    # Step 4: Run tests
    - name: Run Tests Palantir-Core
      id: run-tests-palantir-core
      shell: pwsh
      run: |
        & "C:\Program Files\OpenCppCoverage\OpenCppCoverage.exe" --export_type=binary:${{ inputs.build-dir }}\bin\coverage\palantir-core.cov --modules="${{ github.workspace }}\build\bin\palantir-core.dll" --cover_children ${{ inputs.build-dir }}\bin\palantir_core_tests.exe

    # Step 5: Run tests
    - name: Run Tests Commands Plugin
      id: run-tests-commands-plugin
      shell: pwsh
      run: |
        & "C:\Program Files\OpenCppCoverage\OpenCppCoverage.exe" --input_coverage=${{ inputs.build-dir }}\bin\coverage\palantir-core.cov --export_type=cobertura:${{ inputs.build-dir }}\bin\coverage\final.xml --modules="${{ github.workspace }}\build\bin\commands_plugin.dll" --cover_children ${{ inputs.build-dir }}\bin\commands_plugin_tests.exe

    - name: Display coverage
      shell: pwsh
      run: |
        ls -R ${{ inputs.build-dir }}\bin\coverage
        Write-Host "Coverage report found at ${{ inputs.build-dir }}\bin\coverage\final.xml with content: $(Get-Content ${{ inputs.build-dir }}\bin\coverage\final.xml)"

    # Step 3: Save build cache
    - name: Save Build Cache
      uses: actions/cache/save@v3
      with:
        path: |
          ${{ inputs.build-dir }}
          ${{ inputs.build-dir }}/CMakeCache.txt
          ${{ inputs.build-dir }}/CMakeFiles
          ${{ inputs.build-dir }}/_deps
        key: ${{ inputs.cache-key }}-tests
